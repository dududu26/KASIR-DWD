<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Harian Kasir</title>
  <style>
    /* Tambahan style tombol sederhana */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }
    h1, h3, label {
      color: #333;
    }
    .btn-container {
      margin-bottom: 20px;
    }
    .btn {
      background-color: #2575fc;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 10px;
      transition: background-color 0.3s ease;
    }
    .btn:hover {
      background-color: #1b59d9;
    }
    .input-group {
      margin: 20px 0;
    }
    .input-group label {
      margin-right: 10px;
      font-weight: 600;
    }
    .input-group input {
      padding: 6px 8px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .result-untung-rugi {
      margin-top: 15px;
      font-size: 1.2em;
      font-weight: 700;
    }
    .profit {
      color: green;
    }
    .loss {
      color: red;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      text-align: left;
    }
    th {
      background-color: #2575fc;
      color: white;
    }
  </style>
</head>
<body>
  <div class="btn-container">
    <button id="btn-dashboard" class="btn">Kembali ke Dashboard</button>
    <button id="btn-kasir" class="btn">Kembali ke Kasir</button>
    <button id="btn-inventory" class="btn">Kembali ke Inventory</button>
  </div>

  <h1>Laporan Harian Kasir</h1>

  <label for="date-select">Pilih Tanggal:</label>
  <select id="date-select">
    <option value="">-- Pilih tanggal --</option>
  </select>

  <h3>Total uang masuk hari ini: <span id="total-uang-masuk">0</span></h3>

  <div class="input-group">
    <label for="input-uang-masuk">Input Uang Masuk:</label>
    <input
      type="number"
      id="input-uang-masuk"
      placeholder="Masukkan jumlah uang masuk"
      min="0"
      step="1000"
    />
    <button id="btn-hitung-untung-rugi" class="btn">Hitung Untung/Rugi</button>
  </div>

  <div id="hasil-untung-rugi" class="result-untung-rugi"></div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ID Transaksi</th>
          <th>Waktu Transaksi</th>
          <th>Produk</th>
          <th>Qty</th>
          <th>Total Harga</th>
        </tr>
      </thead>
      <tbody id="transaksi-body"></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://uupzrnmmsqnogbqivstj.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1cHpybm1tc3Fub2dicWl2c3RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwNjAyNzksImV4cCI6MjA2MzYzNjI3OX0.1bTJ9FGNZ8ou20gngHfhE_r7sI23AfYh0jtWyQFqSiI'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const totalUangMasukElem = document.getElementById('total-uang-masuk')
    const tbody = document.getElementById('transaksi-body')
    const dateSelect = document.getElementById('date-select')
    const inputUangMasuk = document.getElementById('input-uang-masuk')
    const btnHitung = document.getElementById('btn-hitung-untung-rugi')
    const hasilUntungRugiElem = document.getElementById('hasil-untung-rugi')

    // Tombol navigasi
    document.getElementById('btn-dashboard').addEventListener('click', () => {
      window.location.href = 'index.html'
    })
    document.getElementById('btn-kasir').addEventListener('click', () => {
      window.location.href = 'kasir.html'
    })
    document.getElementById('btn-inventory').addEventListener('click', () => {
      window.location.href = 'inventory.html'
    })

    const LAST_RESET_KEY = 'last_reset_date'

    async function saveDailyTotal(date, total) {
      const { data, error } = await supabase
        .from('daily_totals')
        .upsert({ date, total }, { onConflict: 'date' })

      if (error) console.error('Error simpan daily total:', error)
    }

    async function getDailyTotalsList() {
      const { data, error } = await supabase
        .from('daily_totals')
        .select('date')
        .order('date', { ascending: false })

      if (error) {
        console.error('Error fetch daily totals list:', error)
        return []
      }
      return data.map(row => row.date)
    }

    async function getDailyTotalByDate(date) {
      const { data, error } = await supabase
        .from('daily_totals')
        .select('total')
        .eq('date', date)
        .single()

      if (error) {
        console.error('Error fetch daily total by date:', error)
        return null
      }
      return data ? data.total : null
    }

    async function loadTransactions(filterDate = null) {
      let query = supabase
        .from('transactions')
        .select('id, created_at, items, total')
        .order('created_at', { ascending: true })

      if (filterDate) {
        const start = new Date(filterDate)
        start.setHours(0, 0, 0, 0)
        const end = new Date(filterDate)
        end.setHours(23, 59, 59, 999)

        query = query.gte('created_at', start.toISOString()).lte('created_at', end.toISOString())
      }

      const { data, error } = await query

      if (error) {
        console.error('Error load transactions:', error)
        return 0
      }

      tbody.innerHTML = ''
      let totalUangMasuk = 0

      data.forEach(tx => {
        const items = typeof tx.items === 'string' ? JSON.parse(tx.items) : tx.items
        items.forEach(item => {
          const tr = document.createElement('tr')
          tr.innerHTML = `
            <td>${tx.id}</td>
            <td>${new Date(tx.created_at).toLocaleString()}</td>
            <td>${item.product_name}</td>
            <td>${item.qty}</td>
            <td>${item.total.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' })}</td>
          `
          tbody.appendChild(tr)
        })
        totalUangMasuk += Number(tx.total)
      })

      totalUangMasukElem.textContent = totalUangMasuk.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' })

      return totalUangMasuk
    }

    async function loadDateDropdown() {
      const dates = await getDailyTotalsList()
      dateSelect.innerHTML = `<option value="">-- Pilih tanggal --</option>`
      dates.forEach(date => {
        const option = document.createElement('option')
        option.value = date
        option.textContent = new Date(date).toLocaleDateString('id-ID')
        dateSelect.appendChild(option)
      })
    }

    async function handleDateSelect() {
      const selectedDate = dateSelect.value
      if (!selectedDate) {
        await loadTransactions()
        totalUangMasukElem.textContent = '0'
        inputUangMasuk.value = ''
        hasilUntungRugiElem.textContent = ''
        return
      }

      const totalDaily = await getDailyTotalByDate(selectedDate)
      totalUangMasukElem.textContent = totalDaily
        ? Number(totalDaily).toLocaleString('id-ID', { style: 'currency', currency: 'IDR' })
        : '0'

      await loadTransactions(selectedDate)
      inputUangMasuk.value = ''
      hasilUntungRugiElem.textContent = ''
    }

    async function checkAndResetIfNeeded() {
      const now = new Date()
      const todayStr = now.toISOString().split('T')[0]
      const lastReset = localStorage.getItem(LAST_RESET_KEY)

      if (now.getHours() > 10 || (now.getHours() === 10 && now.getMinutes() >= 30)) {
        if (lastReset !== todayStr) {
          const yesterday = new Date(now)
          yesterday.setDate(yesterday.getDate() - 1)
          const yesterdayStr = yesterday.toISOString().split('T')[0]

          const totalKemarin = await loadTransactions(yesterdayStr)
          await saveDailyTotal(yesterdayStr, totalKemarin)

          localStorage.setItem(LAST_RESET_KEY, todayStr)
          await loadTransactions(todayStr)
        } else {
          await loadTransactions(todayStr)
        }
      } else {
        const yesterday = new Date(now)
        yesterday.setDate(yesterday.getDate() - 1)
        const yesterdayStr = yesterday.toISOString().split('T')[0]

        await loadTransactions(yesterdayStr)
      }

      inputUangMasuk.value = ''
      hasilUntungRugiElem.textContent = ''
    }

    function hitungUntungRugi() {
      const totalTransaksi = parseFloat(totalUangMasukElem.textContent.replace(/[^0-9.-]+/g,"")) || 0
      const inputUang = parseFloat(inputUangMasuk.value) || 0
      const selisih = inputUang - totalTransaksi

      if (inputUang === 0) {
        hasilUntungRugiElem.textContent = ''
        return
      }

      if (selisih > 0) {
        hasilUntungRugiElem.innerHTML = `<span class="profit">Untung: ${selisih.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' })}</span>`
      } else if (selisih < 0) {
        hasilUntungRugiElem.innerHTML = `<span class="loss">Rugi: ${Math.abs(selisih).toLocaleString('id-ID', { style: 'currency', currency: 'IDR' })}</span>`
      } else {
        hasilUntungRugiElem.textContent = 'Untung/Rugi: Nol (Seimbang)'
      }
    }

    dateSelect.addEventListener('change', handleDateSelect)
    btnHitung.addEventListener('click', hitungUntungRugi)

    async function init() {
      await loadDateDropdown()
      await checkAndResetIfNeeded()
    }

    init()
  </script>
</body>
</html>